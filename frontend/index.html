<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>üé∂ Sincronizador de Letras (Karaoke)</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css  "
            rel="stylesheet">
        <script
            src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js  "></script>
        <style>
    body { background: #121212; color: white; text-align: center; }
    .lyrics { font-size: 1.25rem; margin-top: 20px; line-height: 1.6; text-align: left; max-width: 900px; margin: 0 auto; }
    .line { margin: 8px 0; padding: 6px 8px; border-radius: 8px; display: block; width: 100%; }
    .line .word { display: inline-block; white-space: pre; transition: color .15s ease, text-shadow .15s ease, transform .15s ease; color: #fff; }
    .line.highlight { transform: scale(1.02); }
    .word.active { color: #00e0ff; text-shadow: 0 0 8px #00e0ff; }
    #progressContainer { width: 100%; margin-top: 18px; display: none; max-width: 900px; margin-left: auto; margin-right: auto; }
    .controls { max-width: 900px; margin: 0 auto; }
    .small-muted { color: #9aa4b2; font-size: .9rem; margin-top: 6px; }
  </style>
    </head>
    <body class="p-4">
        <h2>üéµ Transcriptor + Karaoke sincronizado</h2>

        <div class="controls my-3">
            <div class="d-flex gap-2 mb-2">
                <input id="taskInput" type="text"
                    placeholder="Ingrese Task ID existente"
                    class="form-control">
                <button id="btnCargar" class="btn btn-success">Cargar</button>
            </div>

            <form id="uploadForm" class="d-flex gap-2 mb-2"
                style="align-items: center;">
                <input type="file" id="audioFile" name="file"
                    class="form-control" accept="audio/*">
                <button id="btnSubir" type="submit"
                    class="btn btn-primary">Subir y transcribir</button>
            </form>

            <div class="d-flex gap-2 mb-2">
                <button id="playKaraoke" class="btn btn-success"
                    style="display:none;">‚ñ∂Ô∏è Reproducir karaoke</button>
                <button id="pauseKaraoke" class="btn btn-secondary"
                    style="display:none;">‚è∏ Pausa</button>
            </div>

            <div id="progressContainer">
                <div class="progress">
                    <div id="progressBar"
                        class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width:0%">0%</div>
                </div>
                <div id="progressText" class="small-muted">Preparando...</div>
            </div>
        </div>

        <audio id="player" controls class="w-100 my-3"></audio>
        <div id="lyrics" class="lyrics"></div>

        <script>
    const btnCargar = document.getElementById('btnCargar');
    const taskInput = document.getElementById('taskInput');
    const form = document.getElementById('uploadForm');
    const player = document.getElementById('player');
    const lyricsDiv = document.getElementById('lyrics');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const btnSubir = document.getElementById('btnSubir');
    const playKaraokeBtn = document.getElementById('playKaraoke');
    const pauseKaraokeBtn = document.getElementById('pauseKaraoke');

    let segments = [];
    let grouped = [];
    let lastActiveLine = -1;
    let lastActiveWord = -1;

    // üîπ Funci√≥n modificada: agrupar frases por signos de puntuaci√≥n
    async function cargarResultados(taskId) {
      const res = await fetch(`http://localhost:8000/result/${taskId}`);
      const data = await res.json();
      if (data.error) { alert("Error: " + data.error); return; }

      segments = data.segments || [];
      player.src = 'http://localhost:8000' + data.audio_file;

      // üëá Usa el offset para ajustar el inicio
      const offset = data.offset || 0;
      const totalDuration = data.total_duration || 0;

      grouped = [];
      let currentLine = { start: 0, end: 0, words: [] };
      const punctuation = /[.,;!?¬°¬ø]/;

      for (let i = 0; i < segments.length; i++) {
        const seg = segments[i];
        const text = seg.text.trim();
        if (!text) continue;

        // üëá Ajusta los tiempos de cada segmento restando el offset
        const adjustedStart = Math.max(0, seg.start - offset);
        const adjustedEnd = Math.max(0, seg.end - offset);

        currentLine.words.push({ text, start: adjustedStart, end: adjustedEnd });
        currentLine.end = adjustedEnd;

        const endsWithPunct = punctuation.test(text.slice(-1));
        const enoughWords = currentLine.words.length >= 2;

        if (endsWithPunct && enoughWords) {
          currentLine.start = currentLine.words[0].start;
          grouped.push(currentLine);
          currentLine = { start: 0, end: 0, words: [] };
        }
      }
      if (currentLine.words.length > 1) grouped.push(currentLine);

      // Renderizado
      lyricsDiv.innerHTML = grouped.map((line, idx) => {
        const wordsHtml = line.words.map((w, wi) => `<span class="word" data-word-index="${wi}" data-line-index="${idx}">${escapeHtml(w.text)} </span>`).join('');
        return `<div class="line" data-line-index="${idx}" data-start="${line.start}" data-end="${line.end}">${wordsHtml}</div>`;
      }).join('');

      playKaraokeBtn.style.display = 'inline-block';
      pauseKaraokeBtn.style.display = 'inline-block';

      // üëá Configura el offset en el reproductor
      player.addEventListener('loadedmetadata', () => {
        player.currentTime = offset; // Empieza desde el offset
      }, { once: true });

      // Opcional: mostrar el offset en la UI para debugging
      progressText.textContent = `Offset: ${offset.toFixed(2)}s | Duraci√≥n total: ${totalDuration ? totalDuration.toFixed(2) : 'N/A'}s`;
    }

    function escapeHtml(s) {
      return s.replace(/&/g, "&amp;").replace(/</g, "<").replace(/>/g, ">");
    }

    btnCargar.addEventListener('click', async () => {
      const taskId = taskInput.value.trim();
      if (!taskId) return alert("Ingresa un task_id v√°lido");
      await cargarResultados(taskId);
      player.play().catch(()=>{});
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('audioFile');
      if (!fileInput.files.length) return alert("Selecciona un archivo de audio");
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);

      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Subiendo archivo...';
      btnSubir.disabled = true;

      const uploadResp = await fetch('http://localhost:8000/transcribe/', { method: 'POST', body: fd });
      const uploadData = await uploadResp.json();
      if (uploadData.error) { alert(uploadData.error); btnSubir.disabled = false; return; }

      const taskId = uploadData.task_id;
      player.src = 'http://localhost:8000' + uploadData.audio_file;

      const interval = setInterval(async () => {
        const p = await fetch(`http://localhost:8000/progress/${taskId}`);
        const info = await p.json();
        const pct = Math.min(info.progress || 0, 100);
        progressBar.style.width = pct + '%';
        progressBar.textContent = Math.round(pct) + '%';

        if (info.status === 'done' || info.status === 'completed') {
          clearInterval(interval);
          await cargarResultados(taskId);
          progressContainer.style.display = 'none';
          btnSubir.disabled = false;
          player.play().catch(()=>{});
        } else if (info.status === 'error') {
          clearInterval(interval);
          progressText.textContent = 'Error al procesar el archivo.';
          btnSubir.disabled = false;
        }
      }, 1500);
    });

    playKaraokeBtn.addEventListener('click', () => player.play());
    pauseKaraokeBtn.addEventListener('click', () => player.pause());

    // üîπ Karaoke sincronizado palabra por palabra
    player.addEventListener('timeupdate', () => {
      const t = player.currentTime;
      if (!grouped.length) return;

      // Buscar la l√≠nea activa
      const lineIndex = grouped.findIndex(l => t >= l.start && t <= l.end);
      if (lineIndex === -1) return;

      if (lineIndex !== lastActiveLine) {
        lastActiveLine = lineIndex;
        document.querySelectorAll('.line').forEach((el, i) => el.classList.toggle('highlight', i === lineIndex));
        const activeLine = document.querySelector(`.line[data-line-index="${lineIndex}"]`);
        if (activeLine) activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      const line = grouped[lineIndex];

      // üëá Buscar la palabra activa usando los tiempos exactos
      let wordIndex = -1;
      for (let i = 0; i < line.words.length; i++) {
        const word = line.words[i];
        if (t >= word.start && t <= word.end) {
          wordIndex = i;
          break;
        }
      }

      if (wordIndex !== lastActiveWord) {
        lastActiveWord = wordIndex;
        const wordEls = document.querySelectorAll(`.line[data-line-index="${lineIndex}"] .word`);
        wordEls.forEach((el, i) => el.classList.toggle('active', i <= wordIndex));
        const activeEl = wordEls[wordIndex];
        if (activeEl) anime({ targets: activeEl, scale: [1, 1.07, 1], duration: 300, easing: 'easeOutQuad' });
      }
    });
</script>
    </body>
</html>