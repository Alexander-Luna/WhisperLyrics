<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>üé∂ Sincronizador de Letras</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <script
            src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
        <style>
    body { background: #121212; color: white; text-align: center; }
    .lyrics { font-size: 1.3rem; margin-top: 20px; line-height: 1.6; }
    .highlight { color: #00e0ff; font-weight: bold; text-shadow: 0 0 8px #00e0ff; }
    #progressContainer { width: 100%; margin-top: 20px; display: none; }
    .line {
  transition: transform 0.3s ease;
  margin-bottom: 10px;
}
.highlight {
  transform: scale(1.05);
}
  </style>
    </head>
    <body class="p-4">
        <h2>üéµ Transcriptor + Letras Sincronizadas</h2>
        <div class="mt-4">
            <input id="taskInput" type="text"
                placeholder="Ingrese Task ID existente"
                class="form-control mb-2">
            <button id="btnCargar" class="btn btn-success">Cargar resultados
                existentes</button>
        </div>
        <form id="uploadForm" class="my-4">
            <input type="file" id="audioFile" name="file"
                class="form-control mb-3" accept="audio/*" required>
            <button id="btnSubir" type="submit" class="btn btn-primary">Subir y
                Transcribir</button>
        </form>
        <button id="playKaraoke" class="btn btn-success my-2"
            style="display:none;">
            ‚ñ∂Ô∏è Reproducir con letra
        </button>
        <!-- Barra de progreso -->
        <div id="progressContainer">
            <div class="progress">
                <div id="progressBar"
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar" style="width: 0%">0%</div>
            </div>
            <div id="progressText" class="mt-2 text-info">Preparando
                transcripci√≥n...</div>

        </div>

        <audio id="player" controls class="w-100 my-3"></audio>
        <div id="lyrics" class="lyrics"></div>
        <script>
const btnCargar = document.getElementById('btnCargar');
const taskInput = document.getElementById('taskInput');


btnCargar.addEventListener('click', async () => {
  const taskId = taskInput.value.trim();
  if (!taskId) return alert("Por favor ingresa un task_id v√°lido.");

  await cargarResultados(taskId);

  // Cargar el audio vinculado
  const audioPath = `http://localhost:8000/uploads/${taskId}.mp3`;
  player.src = audioPath;
  player.play();

  progressText.textContent = 'üéµ Reproduciendo con letra sincronizada...';
});


const playKaraokeBtn = document.getElementById('playKaraoke');

async function cargarResultados(taskId) {
  const res = await fetch(`http://localhost:8000/result/${taskId}`);
  const data = await res.json();

  if (data.error) {
    alert("Error al obtener resultados: " + data.error);
    return;
  }

  segments = data.segments;
  player.src = 'http://localhost:8000' + data.audio_file;

  lyricsDiv.innerHTML = segments.map(s => {
    const words = s.text.split(' ').map(w => `<span>${w} </span>`).join('');
    return `<div class="line">${words}</div>`;
  }).join('');

  playKaraokeBtn.style.display = 'inline-block';
}

playKaraokeBtn.addEventListener('click', () => {
  player.currentTime = 0;
  player.play();
});


const form = document.getElementById('uploadForm');
const player = document.getElementById('player');
const lyricsDiv = document.getElementById('lyrics');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const btnSubir = document.getElementById('btnSubir');
const progressText = document.getElementById('progressText');
let segments = [];

form.addEventListener('submit', async e => {
  e.preventDefault();
  const fileInput = document.getElementById('audioFile');
  if (!fileInput.files.length) return alert("Por favor selecciona un archivo de audio.");

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);

  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';
  progressText.textContent = 'Subiendo archivo...';
btnSubir.disabled = true;
  // 1Ô∏è‚É£ Subir archivo
  const response = await fetch('http://localhost:8000/transcribe/', {
    method: 'POST',
    body: formData
  });

  const data = await response.json();
  if (data.error) return alert(data.error);

  const taskId = data.task_id;
  player.src = 'http://localhost:8000' + data.audio_file;
  progressText.textContent = 'Transcribiendo...';
btnSubir.disabled = true;
  // 2Ô∏è‚É£ Consultar progreso cada 2 segundos
  const interval = setInterval(async () => {
    const res = await fetch(`http://localhost:8000/progress/${taskId}`);
    const info = await res.json();
    if (info.error) return;

    if (info.status === 'processing') {
      progressBar.classList.add('progress-bar-animated');
      progressBar.style.width = Math.min(info.progress, 100) + '%';
      progressBar.textContent = Math.min(info.progress, 100) + '%';
    } else if (info.status === 'saving') {
      progressText.textContent = 'Guardando resultados...';
    } else if (info.status === 'done' || info.status === 'completed') {
      clearInterval(interval);
      progressText.textContent = '‚úÖ Transcripci√≥n completada';
      btnSubir.disabled = false;
      progressContainer.style.display = 'none';
      await cargarResultados(taskId);
    } else if (info.status === 'error') {
      clearInterval(interval);
      alert('‚ùå Error en la transcripci√≥n');
      btnSubir.disabled = false;
    }
  }, 2000);
});
async function cargarResultados(taskId) {
  const res = await fetch(`http://localhost:8000/result/${taskId}`);
  const data = await res.json();

  if (data.error) return alert("Error al obtener resultados: " + data.error);

  segments = data.segments;
  const offset = data.offset || 0;

  // Adelantar el audio hasta donde empieza el canto
  player.currentTime = offset;

  lyricsDiv.innerHTML = segments.map(s => {
    const words = s.text.split(' ').map(w => `<span>${w} </span>`).join('');
    return `<div class="line">${words}</div>`;
  }).join('');
}

// üé§ Karaoke progresivo
player.addEventListener('timeupdate', () => {
  const current = player.currentTime;
  const activeIndex = segments.findIndex(s => current >= s.start && current <= s.end);
  if (activeIndex === -1) return;

  const activeLine = lyricsDiv.children[activeIndex];
  [...lyricsDiv.children].forEach((el, i) => {
    el.classList.toggle('highlight', i === activeIndex);
  });

  const s = segments[activeIndex];
  const progress = (current - s.start) / (s.end - s.start);

  const words = activeLine.querySelectorAll('span');
  const wordsToHighlight = Math.floor(progress * words.length);

  words.forEach((w, i) => {
    if (i < wordsToHighlight) {
      w.style.color = '#00e0ff';
      w.style.textShadow = '0 0 8px #00e0ff';
    } else {
      w.style.color = 'white';
      w.style.textShadow = 'none';
    }
  });

  activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
});
</script>

    </body>
</html>
